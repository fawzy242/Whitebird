<!-- File Upload Component Page -->
<div id="fileUploadPage">
    <div class="page-header mb-4">
        <h1><i class="fas fa-cloud-upload-alt me-2"></i>File Upload & Download</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/dashboard">Home</a></li>
                <li class="breadcrumb-item active">File Upload</li>
            </ol>
        </nav>
    </div>

    <div class="row g-4">
        <!-- Drag & Drop Upload -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-file-upload me-2"></i>Drag & Drop Upload</h5>
                </div>
                <div class="card-body">
                    <div class="upload-zone" id="uploadZone">
                        <i class="fas fa-cloud-upload-alt fa-4x mb-3 text-primary"></i>
                        <h5>Drag & Drop files here</h5>
                        <p class="text-muted mb-3">or click to browse</p>
                        <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-folder-open me-2"></i>Browse Files
                        </button>
                        <input type="file" id="fileInput" multiple hidden>
                    </div>

                    <div class="file-list mt-3" id="fileList"></div>
                </div>
            </div>
        </div>

        <!-- Image Upload with Preview -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-image me-2"></i>Image Upload with Preview</h5>
                </div>
                <div class="card-body">
                    <div class="image-upload-zone text-center" id="imageUploadZone">
                        <div class="image-preview mb-3" id="imagePreview">
                            <i class="fas fa-image fa-4x text-muted"></i>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="document.getElementById('imageInput').click()">
                            <i class="fas fa-camera me-2"></i>Upload Image
                        </button>
                        <input type="file" id="imageInput" accept="image/*" hidden>
                        <p class="text-muted mt-2 mb-0">Supported: JPG, PNG, GIF (Max 5MB)</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Uploaded Files -->
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-folder-open me-2"></i>Uploaded Files</h5>
                    <button class="btn btn-sm btn-danger" onclick="fileManager.clearAll()">
                        <i class="fas fa-trash me-2"></i>Clear All
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Preview</th>
                                    <th>File Name</th>
                                    <th>Size</th>
                                    <th>Type</th>
                                    <th>Upload Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="uploadedFiles">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">
                                        No files uploaded yet
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.upload-zone {
    border: 3px dashed var(--border-color);
    border-radius: 1rem;
    padding: 3rem 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.upload-zone:hover,
.upload-zone.dragover {
    border-color: var(--primary-red);
    background: var(--light-red);
}

.image-preview {
    width: 200px;
    height: 200px;
    border: 3px solid var(--border-color);
    border-radius: 1rem;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    background: var(--gray-light);
}

.image-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.file-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem;
    background: var(--gray-light);
    border-radius: 0.5rem;
    margin-bottom: 0.5rem;
}

.file-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex: 1;
}

.file-icon {
    width: 40px;
    height: 40px;
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--primary-red);
    color: white;
    font-size: 1.25rem;
}

.file-preview-thumb {
    width: 50px;
    height: 50px;
    border-radius: 0.5rem;
    object-fit: cover;
}

[data-theme="dark"] .upload-zone {
    background: var(--bg-input);
}

[data-theme="dark"] .file-item {
    background: var(--bg-input);
}
</style>

<script type="module">
import { confirmModal } from '../src/components/confirm-modal.component.js';

class FileManager {
    constructor() {
        this.files = [];
        this.init();
    }

    init() {
        this.setupDropZone();
        this.setupFileInput();
        this.setupImageUpload();
    }

    setupDropZone() {
        const zone = document.getElementById('uploadZone');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            zone.addEventListener(eventName, this.preventDefaults, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            zone.addEventListener(eventName, () => zone.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            zone.addEventListener(eventName, () => zone.classList.remove('dragover'), false);
        });

        zone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            this.handleFiles(files);
        }, false);

        zone.addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });
    }

    setupFileInput() {
        document.getElementById('fileInput').addEventListener('change', (e) => {
            this.handleFiles(e.target.files);
        });
    }

    setupImageUpload() {
        document.getElementById('imageInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                this.previewImage(file);
            }
        });
    }

    preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    handleFiles(files) {
        [...files].forEach(file => {
            this.addFile(file);
        });
    }

    addFile(file) {
        const fileData = {
            id: Date.now() + Math.random(),
            name: file.name,
            size: this.formatFileSize(file.size),
            type: file.type,
            date: new Date().toLocaleString(),
            file: file
        };

        this.files.push(fileData);
        this.renderFiles();
        this.showFileInList(file);
    }

    showFileInList(file) {
        const fileList = document.getElementById('fileList');
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        
        const icon = this.getFileIcon(file.type);
        
        fileItem.innerHTML = `
            <div class="file-info">
                <div class="file-icon">${icon}</div>
                <div>
                    <div class="fw-bold">${file.name}</div>
                    <small class="text-muted">${this.formatFileSize(file.size)}</small>
                </div>
            </div>
            <div class="progress" style="width: 200px; height: 8px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%"></div>
            </div>
        `;

        fileList.appendChild(fileItem);

        // Simulate upload progress
        const progressBar = fileItem.querySelector('.progress-bar');
        let progress = 0;
        const interval = setInterval(() => {
            progress += 10;
            progressBar.style.width = progress + '%';
            
            if (progress >= 100) {
                clearInterval(interval);
                setTimeout(() => {
                    fileItem.remove();
                    confirmModal.success('Uploaded!', `${file.name} uploaded successfully!`);
                }, 500);
            }
        }, 100);
    }

    previewImage(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('imagePreview').innerHTML = 
                `<img src="${e.target.result}" alt="Preview">`;
        };
        reader.readAsDataURL(file);
        
        this.addFile(file);
    }

    renderFiles() {
        const tbody = document.getElementById('uploadedFiles');
        
        if (this.files.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        No files uploaded yet
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = this.files.map(file => {
            const isImage = file.type.startsWith('image/');
            const preview = isImage ? 
                `<img src="${URL.createObjectURL(file.file)}" class="file-preview-thumb" alt="${file.name}">` :
                `<div class="file-icon">${this.getFileIcon(file.type)}</div>`;

            return `
                <tr>
                    <td>${preview}</td>
                    <td>${file.name}</td>
                    <td>${file.size}</td>
                    <td><span class="badge bg-info">${file.type || 'Unknown'}</span></td>
                    <td>${file.date}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="fileManager.downloadFile('${file.id}')" title="Download">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="fileManager.deleteFile('${file.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    getFileIcon(type) {
        if (type.startsWith('image/')) return '<i class="fas fa-image"></i>';
        if (type.includes('pdf')) return '<i class="fas fa-file-pdf"></i>';
        if (type.includes('word')) return '<i class="fas fa-file-word"></i>';
        if (type.includes('excel') || type.includes('spreadsheet')) return '<i class="fas fa-file-excel"></i>';
        if (type.includes('zip') || type.includes('rar')) return '<i class="fas fa-file-archive"></i>';
        return '<i class="fas fa-file"></i>';
    }

    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    downloadFile(id) {
        const file = this.files.find(f => f.id == id);
        if (!file) return;

        const url = URL.createObjectURL(file.file);
        const a = document.createElement('a');
        a.href = url;
        a.download = file.name;
        a.click();
        URL.revokeObjectURL(url);

        confirmModal.success('Downloaded!', `${file.name} downloaded successfully!`);
    }

    async deleteFile(id) {
        const confirmed = await confirmModal.delete(
            'Delete File',
            'Are you sure you want to delete this file?'
        );

        if (confirmed) {
            this.files = this.files.filter(f => f.id != id);
            this.renderFiles();
            await confirmModal.success('Deleted!', 'File deleted successfully!');
        }
    }

    async clearAll() {
        if (this.files.length === 0) return;

        const confirmed = await confirmModal.delete(
            'Clear All Files',
            'Are you sure you want to delete all uploaded files?'
        );

        if (confirmed) {
            this.files = [];
            this.renderFiles();
            await confirmModal.success('Cleared!', 'All files deleted successfully!');
        }
    }
}

// Initialize
window.fileManager = new FileManager();
</script>
